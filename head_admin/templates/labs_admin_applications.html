{% extends 'main/general.html' %}
{% load crispy_forms_tags %}
{% load static %}
{% block title %}–ü—Ä–æ—Å–º–æ—Ç—Ä —Ç–µ–∫—É—â–∏—Ö –∑–∞—è–≤–æ–∫{% endblock %}
{% block body %}

<div class="container">
    <h1 class="header_text" >–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞—è–≤–æ–∫</h1><br>

    <form action="{% url 'head_admin:applications_by_status' %}" method="POST" class="d-flex flex-column my-2">
        {% csrf_token %}
        <div class="d-flex flex-column border border-1 border-emphasis px-4 rounded">
            <h5 class="h5 my-2">–§–∏–ª—å—Ç—Ä</h5>
            <div class="mb-3 row">
                <label for="dateFilter" class="col-sm-2 col-form-label">–î–∞—Ç–∞</label>
                <div class="col-sm-4">
                  <input type="date" class="form-control" name="date_filter" {% if filters.date__contains != None %} value="{{filters.date__contains}}" {% endif %} id="dateFilter">
                </div>
            </div>
            <div class="mb-3 row">
                <label for="statusFilter" class="col-sm-2 col-form-label">–°—Ç–∞—Ç—É—Å</label>
                <div class="col-sm-4">
                    <select class="form-select" name="status_application" id="statusFilter" aria-label="–°—Ç–∞—Ç—É—Å—ã">
                        <option 
                            value="0" 
                            {% if filters.status_application != None and filters.status_application == status.id %} selected {% endif %}
                        >–í—Å–µ
                        </option>
                        {% for status in statuses %}
                        <option 
                            value="{{status.id}}" 
                            {% if filters.status_application != None and filters.status_application == status.id %} selected {% endif %}
                        >{{status.name}}
                        </option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="mb-3 row">
                <label for="statusFilter" class="col-sm-2 col-form-label">–ö–∞–±–∏–Ω–µ—Ç</label>
                <div class="col-sm-4">
                    <select class="form-select" name="number_cab" id="statusFilter" aria-label="–°—Ç–∞—Ç—É—Å—ã">
                        <option 
                            value="0" 
                            {% if filters.number_cab != None and filters.number_cab == 0 %} selected {% endif %}
                        >–í—Å–µ
                        </option>
                        {% for cab in cabinets %}
                        <option 
                            value="{{cab.id}}" 
                            {% if filters.number_cab != None and filters.number_cab == cab.id %} selected {% endif %}
                        >{{cab.number}}
                        </option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="d-flex flex-row justify-content-start align-items-center my-2">
                <button type="submit" class="btn btn-info">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
            </div>
        </div>
    </form>

    <table class="table table-bordered">
        <thead>
        <tr>
            <th>
                ‚Ññ
                <form action="{% url 'head_admin:applications_by_status' %}" method="POST" class="d-inline-block p-1">
                    {% csrf_token %}
                    <input type="hidden" name="sorting" value="id">
                    {% if current_sorting == 'id' and current_ascing == 1 %}
                        <input type="hidden" name="ascing" value="0">
                    {% else %}
                        <input type="hidden" name="ascing" value="1">
                    {% endif %}
                    <button type="submit" class="btn btn-outline-info">
                        {% if current_sorting == 'id' and current_ascing == 1 %}
                        ü†ó
                        {% else %}
                        ü†ï
                        {% endif %}
                    </button>
                </form>
            </th>
            <th>
                –î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è
                <form action="{% url 'head_admin:applications_by_status' %}" method="POST" class="d-inline-block p-1">
                    {% csrf_token %}
                    <input type="hidden" name="sorting" value="date">
                    {% if current_sorting == 'date' and current_ascing == 1 %}
                        <input type="hidden" name="ascing" value="0">
                    {% else %}
                        <input type="hidden" name="ascing" value="1">
                    {% endif %}
                    <button type="submit" class="btn btn-outline-info">
                        {% if current_sorting == 'date' and current_ascing == 1 %}
                        ü†ó
                        {% else %}
                        ü†ï
                        {% endif %}
                    </button>
                </form>
            </th>
            <th>
                –ó–∞—è–≤–∏—Ç–µ–ª—å
                <form action="{% url 'head_admin:applications_by_status' %}" method="POST" class="d-inline-block p-1">
                    {% csrf_token %}
                    <input type="hidden" name="sorting" value="auth_user">
                    {% if current_sorting == 'auth_user' and current_ascing == 1 %}
                        <input type="hidden" name="ascing" value="0">
                    {% else %}
                        <input type="hidden" name="ascing" value="1">
                    {% endif %}
                    <button type="submit" class="btn btn-outline-info">
                        {% if current_sorting == 'auth_user' and current_ascing == 1 %}
                        ü†ó
                        {% else %}
                        ü†ï
                        {% endif %}
                    </button>
                </form>
            </th>
            <th>
                –ö–∞–±–∏–Ω–µ—Ç
                <form action="{% url 'head_admin:applications_by_status' %}" method="POST" class="d-inline-block p-1">
                    {% csrf_token %}
                    <input type="hidden" name="sorting" value="number_cab">
                    {% if current_sorting == 'number_cab' and current_ascing == 1 %}
                        <input type="hidden" name="ascing" value="0">
                    {% else %}
                        <input type="hidden" name="ascing" value="1">
                    {% endif %}
                    <button type="submit" class="btn btn-outline-info">
                        {% if current_sorting == 'number_cab' and current_ascing == 1 %}
                        ü†ó
                        {% else %}
                        ü†ï
                        {% endif %}
                    </button>
                </form>
            </th>
            <th>
                –û–ø–∏—Å–∞–Ω–∏–µ
                <form action="{% url 'head_admin:applications_by_status' %}" method="POST" class="d-inline-block p-1">
                    {% csrf_token %}
                    <input type="hidden" name="sorting" value="description">
                    {% if current_sorting == 'description' and current_ascing == 1 %}
                        <input type="hidden" name="ascing" value="0">
                    {% else %}
                        <input type="hidden" name="ascing" value="1">
                    {% endif %}
                    <button type="submit" class="btn btn-outline-info">
                        {% if current_sorting == 'description' and current_ascing == 1 %}
                        ü†ó
                        {% else %}
                        ü†ï
                        {% endif %}
                    </button>
                </form>
            </th>
            <th>
                –°—Ç–∞—Ç—É—Å
                <form action="{% url 'head_admin:applications_by_status' %}" method="POST" class="d-inline-block p-1">
                    {% csrf_token %}
                    <input type="hidden" name="sorting" value="status_application">
                    {% if current_sorting == 'status_application' and current_ascing == 1 %}
                        <input type="hidden" name="ascing" value="0">
                    {% else %}
                        <input type="hidden" name="ascing" value="1">
                    {% endif %}
                    <button type="submit" class="btn btn-outline-info">
                        {% if current_sorting == 'status_application' and current_ascing == 1 %}
                        ü†ó
                        {% else %}
                        ü†ï
                        {% endif %}
                    </button>
                </form>
            </th>
            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
        </tr>
        </thead>
        <tbody>
        {% for application in applications %}
            <tr>
            <td>{{ application.id }}</td>
            <td>{{ application.date }}</td>
            <td>{{ application.auth_user.username }}</td>
            <td>{{ application.number_cab }}</td>
            <td>{{ application.description }}</td>
            <td>{{ application.status_application.name }}</td>
            <td>
                <div class="d-flex flex-row align-items-center">
                    {% if application.status_application.id == 2 %}
                    <form class="mx-2" method="POST" action="{% url 'head_admin:edit_application' application.id %}">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-success">–ü—Ä–∏–Ω—è—Ç—å —Ä–∞–±–æ—Ç—É</button>
                    </form>
                    <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#returnApplication{{ application.id }}">
                        –í–µ—Ä–Ω—É—Ç—å
                    </button>
                    <!-- Modal -->
                    <div class="modal fade" id="returnApplication{{ application.id }}" tabindex="-1" aria-labelledby="returnApplicationLabel{{ application.id }}" aria-hidden="true">
                        <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                            <h1 class="modal-title fs-5" id="returnApplicationLabel{{ application.id }}">–§–æ—Ä–º–∞ –æ—Ç–∫–∞–∑–∞ –≤ –ø—Ä–∏–Ω—è—Ç–∏–µ</h1>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <form method="POST" action="{% url 'head_admin:return_application' application.id %}">
                                <div class="modal-body">
                                    {% csrf_token %}
                                    <div class="mb-3">
                                        <label for="comments" class="form-label">–ü—Ä–∏—á–∏–Ω–∞ –æ—Ç–∫–∞–∑–∞</label>
                                        <textarea class="form-control" placeholder="–ü—Ä–∏—á–∏–Ω–∞ –æ—Ç–∫–∞–∑–∞" id="comments" name="comments" required rows="3"></textarea>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>
                                    <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                                </div>
                            </form>
                        </div>
                        </div>
                    </div>
                    {% endif %}

                    {% if application.status_application.id == 5 %}
                    <form class="mx-2" method="POST" action="{% url 'head_admin:archive_application' application.id %}">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-primary">–í –∞—Ä—Ö–∏–≤</button>
                    </form>
                    {% endif %}
    
                    <div class="mx-2">
                        <button class="btn btn-info" type="button" data-bs-toggle="modal" data-bs-target="#historyModal{{ application.id }}">–ò—Å—Ç–æ—Ä–∏—è</button>
                    </div>
                </div>

                <div class="modal fade" id="historyModal{{ application.id }}" tabindex="-1" role="dialog" aria-labelledby="historyModalLabel{{ application.id }}" aria-hidden="true">
                    <div class="modal-dialog modal-xl" role="document">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="historyModalLabel{{ application.id }}">–ò—Å—Ç–æ—Ä–∏—è –∑–∞—è–≤–∫–∏ ‚Ññ{{ application.id }}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <table class="table table-bordered">
                                    <thead>
                                        <tr>
                                            <th>–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è –∏–∑–º–µ–Ω–µ–Ω–∏—è</th>
                                            <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                                            <th>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th>
                                            <th>–°—Ç–∞—Ç—É—Å</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for history_entry in application.history.all %}
                                            <tr>
                                                <td>{{ history_entry.history_date }}</td>
                                                <td>{{ history_entry.history_user }}</td>
                                                {% if history_entry.comments != None %}
                                                <td>{{ history_entry.comments }}</td>
                                                {% else %}
                                                <td></td>
                                                {% endif %}
                                                <td>{{ history_entry.status_application }}</td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>
                            </div>
                        </div>
                    </div>
                </div>

            </td>
            </tr>
        {% endfor %}
        </tbody>
    </table>
</div>



{% endblock %}